generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  username     String   @unique
  password_hash String
  name         String
  phoneNumber  String?  @unique
  role         Role     @default(STUDENT) // Admin/Faculty/Student
  
  // Relations
  professor    Professor?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

enum Role {
  ADMIN
  FACULTY
  STUDENT
}

// ============================================================================
// BUILDING INFRASTRUCTURE
// ============================================================================

model Building {
  id       Int      @id @default(autoincrement())
  name     String   @unique
  code     String   @unique // e.g., "A11"
  
  floors   Floor[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("buildings")
}

model Floor {
  id                   Int      @id @default(autoincrement())
  floor_number         Int
  floor_plan_image_url String?
  building_id          Int
  
  building   Building   @relation(fields: [building_id], references: [id], onDelete: Cascade)
  locations  Location[]
  beacons    Beacons[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([building_id, floor_number])
  @@map("floors")
}

model Department {
  id   Int     @id @default(autoincrement())
  name String  @unique
  type DeptType

  locations  Location[]
  professors Professor[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}

enum DeptType {
  CSD
  CISD
  CEE
  CNCO
  LABS1
  LABS2
  LABS3
  ADMINISTRATION
}

// ============================================================================
// LOCATIONS & NAVIGATION
// ============================================================================

model Location {
  id           Int      @id @default(autoincrement())
  type         LocationType // Classroom/Office/Corridor
  name         String
  room_number  String?
  
  // Coordinates for A* heuristic (Euclidean distance)
  coordinate_x Float
  coordinate_y Float
  
  // Foreign Keys
  floor_id     Int
  department_id Int?
  
  floor        Floor          @relation(fields: [floor_id], references: [id], onDelete: Cascade)
  department   Department?    @relation(fields: [department_id], references: [id])
  
  // Relations for navigation
  beacons      Beacons[]
  outgoing_paths Path[] @relation("start_location")
  incoming_paths Path[] @relation("end_location")
  
  professors   Professor[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([floor_id, room_number])
  @@map("locations")
}

enum LocationType {
  CLASSROOM
  OFFICE
  CORRIDOR
  LAB
  THEATER
  CONFERENCE
  EXIT
  ELEVATOR
  MAIN_HALL
}

// NAVIGATION PATHS (Graph edges for A*)
model Path {
  id                 Int     @id @default(autoincrement())
  start_location_id  Int
  end_location_id    Int
  distance           Float   // Weight for A* algorithm
  
  start_location     Location @relation("start_location", fields: [start_location_id], references: [id], onDelete: Cascade)
  end_location       Location @relation("end_location", fields: [end_location_id], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([start_location_id, end_location_id])
  @@map("paths")
}

// ============================================================================
// BEACONS (BLE POSITIONING)
// ============================================================================

model Beacons {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique // BLE Beacon UUID
  name         String
  operating    Boolean  @default(true)
  
  // Foreign Key
  location_id  Int
  floor_id     Int
  
  location     Location @relation(fields: [location_id], references: [id], onDelete: Cascade)
  floor        Floor    @relation(fields: [floor_id], references: [id], onDelete: Cascade)
  
  // Store recent RSSI readings for moving average
  rssi_readings RssiReading[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("beacons")
}

// Store RSSI readings for weighting moving average
model RssiReading {
  id        Int      @id @default(autoincrement())
  beacon_id Int
  rssi      Int      // RSSI signal strength (negative dBm)
  timestamp DateTime @default(now())
  
  beacon    Beacons  @relation(fields: [beacon_id], references: [id], onDelete: Cascade)

  @@index([beacon_id, timestamp])
  @@map("rssi_readings")
}

// ============================================================================
// FACULTY & OFFICE HOURS
// ============================================================================

model Professor {
  id           Int      @id @default(autoincrement())
  full_name    String
  email        String   @unique
  
  // Foreign Keys
  user_id      Int      @unique
  location_id  Int?     // Office location
  department_id Int
  
  user         User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  office       Location?   @relation(fields: [location_id], references: [id])
  department   Department  @relation(fields: [department_id], references: [id])
  
  office_hours OfficeHours[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("professors")
}

model OfficeHours {
  id           Int      @id @default(autoincrement())
  professor_id Int
  day          DayOfWeek
  start_time   String   // HH:MM format
  end_time     String   // HH:MM format
  
  professor    Professor @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([professor_id, day])
  @@map("office_hours")
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// ============================================================================
// LEGACY MODELS (to be refactored/removed after migration)
// ============================================================================

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

